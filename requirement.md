# 位置情報連動アラームアプリ 要件定義書

## 1. プロジェクト概要

### 1.1 アプリケーション名
位置情報連動アラームアプリ

### 1.2 アプリケーションの目的
指定した場所に到着しない限り、アラームを停止・編集・削除できない仕組みを提供することで、ユーザーが確実に目的地に到着することを促すアラームアプリケーション。

### 1.3 対象プラットフォーム
- iOS（iPhone）

---

## 2. 機能要件

### 2.1 アラーム追加機能
**機能説明：** ユーザーはマップ上でピンを指定して、新しいアラームを追加できます。

**詳細要件：**
- マップ画面を表示し、ピンを配置できる
- ピンを配置した位置をアラームの目的地として設定
- アラームに名前を付けることができる
- アラームの時刻を設定できる
- **重要：** アラームの追加は、その場所に実際にいる必要はない（リモートで設定可能）

**入力項目：**
- アラーム名（テキスト入力、必須）
- アラーム時刻（時刻選択）
- 目的地（マップ上のピン位置）

### 2.2 アラーム停止機能
**機能説明：** アラームが鳴った際に、指定した場所に到着していないと停止できない仕組み。

**詳細要件：**
- **重要：** アプリが完全に閉じている状態（バックグラウンドまたは終了状態）でも、アラームが設定時刻になるとアラームを鳴らす
- 停止ボタンを表示するが、目的地の範囲内(半径100m)にいない場合は停止できない
- 現在位置と目的地の距離をリアルタイムで監視
- 指定した半径内(半径100m)に入った場合のみ、停止ボタンが有効になる

**動作フロー：**
1. アラーム時刻到達（アプリが閉じていても動作）
2. ローカル通知を発火し、アラーム開始
3. ユーザーがアプリを起動し、停止ボタンをタップ
4. 現在位置を取得
5. 目的地との距離を計算
6. 指定半径内(半径100m)：停止可能 → アラーム停止
7. 指定半径外：停止不可 → エラーメッセージ表示

### 2.3 アラーム編集・削除機能
**機能説明：** 既存のアラームの設定を変更したり、削除したりする機能。ただし、目的地の範囲内にいないと編集・削除できない。

**詳細要件：**
- アラーム一覧から編集・削除したいアラームを選択
- 編集画面を表示(この画面に削除ボタンも含める)
- 現在位置を取得し、目的地との距離を計算
- 指定した半径内(半径100m)にいる場合のみ編集・削除可能
- 半径外の場合は、エラーメッセージを表示し編集・削除を拒否
- 編集可能な項目：
  - アラーム名
  - アラーム時刻
  - 目的地（マップ上のピン位置）
  - 有効/無効スイッチ

**動作フロー：**
1. アラーム一覧から編集・削除対象を選択
2. 現在位置を取得
3. 目的地との距離を計算
4. 指定半径内(半径100m)：編集画面を表示 → 編集可能
5. 指定半径外：エラーメッセージ表示 → 編集不可

### 2.4 アラーム一覧表示機能
**機能説明：** 登録されているすべてのアラームを一覧で表示する機能。

**詳細要件：**
- アラーム一覧画面を表示
- 各アラームの情報を表示：
  - アラーム名
  - アラーム時刻
  - 目的地の住所(簡潔に)
  - 有効/無効の状態
- アラームをタップして編集画面に遷移(ただし、位置確認が必要)

### 2.5 位置情報取得機能
**機能説明：** ユーザーの現在位置を取得し、目的地との距離を計算する機能。

**詳細要件：**
- iOSの位置情報サービス（Core Location）を使用
- 位置情報の使用許可をユーザーに求める
- バックグラウンドでも位置情報を取得できるようにする
- GPSの精度を考慮した位置取得(半径100m)
- 目的地との距離をメートル単位で計算

**注意事項：**
- 位置情報の取得には、ユーザーの明示的な許可が必要

### 2.6 マップ表示機能
**機能説明：** アラームの目的地を設定・表示するためのマップ機能。

**詳細要件：**
- マップ画面を表示
- ピンを配置して目的地を指定(デフォルトでは現在地)
- 現在位置をマップ上に表示
- ピンをドラッグして位置を調整可能

---

## 3. 非機能要件

### 3.1 パフォーマンス要件
- アラーム時刻の精度：分単位での正確な通知
- 位置情報の更新頻度：適切な間隔で更新（バッテリー消費を考慮）
- アプリの起動時間：3秒以内

### 3.2 セキュリティ要件
- 位置情報の適切な管理
- ユーザーデータのローカル保存（必要に応じて暗号化）

### 3.3 ユーザビリティ要件
- 直感的なUI/UX
- エラーメッセージは分かりやすく表示
- 位置情報の取得状況を視覚的に表示

### 3.4 互換性要件
- iOS 18.0以上をサポート（推奨）
- iPhoneに対応

---

## 4. 技術要件

### 4.1 開発言語
- **Swift**（iOSアプリケーション開発用のプログラミング言語）

### 4.2 フレームワーク
- 以下のフレームワークを使用
  - SwiftUI（モダンなUI構築フレームワーク）
  - MapKit（地図表示用フレームワーク）
  - Core Location（位置情報取得用フレームワーク）
  - UserNotifications - ローカル通知を実装するためのフレームワーク。アプリが閉じていてもアラームを発火するために必要

### 4.3 使用するAPI・サービス
- マップサービス
  - Apple MapKit（iOS標準の地図サービス）

### 4.4 データ保存
- UserDefaults（軽量データ用）

---

## 5. UI/UX要件

### 5.1 画面構成（想定）
1. **アラーム一覧画面**
   - 登録されているアラームの一覧表示
   - 追加ボタン
   - 各アラームの編集・削除ボタン

2. **アラーム追加/編集画面**
   - アラーム名入力欄
   - 時刻選択ピッカー
   - マップ表示エリア（ピン配置）
   - 保存/キャンセルボタン

4. **アラーム停止画面**
   - アラーム通知表示
   - 停止ボタン（条件付き有効化）

### 5.2 エラーメッセージ
- 「この場所に到着していないため、編集できません」
- 「この場所に到着していないため、アラームを停止できません」
- 「位置情報の取得に失敗しました。設定を確認してください」

---

## 6. その他の事項

### 6.1 アラームサウンド
- **実装方法：バックグラウンドオーディオモード + ローカル通知**
  - アラーム時刻にローカル通知を送信
  - 通知でアプリを起動し、AVAudioPlayerで連続再生を開始
  - 画面がロック状態（オフ）でも、長時間サウンドを鳴らし続ける
  
- **技術的実装：**
  - Info.plistに`UIBackgroundModes`の`audio`を追加（必須）
  - AVAudioSessionのカテゴリを`.playback`に設定
  - AVAudioPlayerで無限ループ（`numberOfLoops = -1`）を設定
  - オーディオセッションを適切に設定して、画面ロック時も継続
  
- **動作の流れ：**
  1. アラーム時刻にローカル通知を送信
  2. 通知でアプリが起動（画面ロック状態でも動作）
  3. AVAudioPlayerでアラーム音を無限ループ再生開始
  4. 画面がロックされても、音は継続的に鳴り続ける
  5. ユーザーがアプリを開いて停止するまで継続
  
- **必要なファイル：**
  - アラーム音ファイル（.caf, .aiff, .wav形式）をプロジェクトに追加
  - ループ可能な音源を推奨（30秒程度）
  
- **制限事項：**
  - 完全に電源がオフ（シャットダウン）の状態では動作しない
  - 画面がロック状態（オフ）であれば動作する
  - バッテリー最適化により、長時間実行が制限される場合がある

### 6.2 バックグラウンド動作
- **実装方法：**
  - ローカル通知（UNUserNotificationCenter）を使用して、アプリが閉じていてもアラームを発火
  - アラーム時刻に到達したら、ローカル通知でユーザーに通知
  - 通知をタップするとアプリが起動し、停止画面を表示
  - バックグラウンドモードの設定（Info.plistにUIBackgroundModesを追加）
- **技術的考慮事項：**
  - iOSのローカル通知は、アプリが完全に終了していても動作する
  - 通知のペイロードにアラーム情報を含める
  - 位置情報のバックグラウンド取得の必要性（アラーム停止時の位置確認用）
  - Significant Location Changes（重要な位置変化）の使用を検討
  - バッテリー消費を最小限に抑える実装

---

## 7. 開発フェーズ

### フェーズ1：基本機能の実装
1. プロジェクトセットアップ
2. マップ表示機能の実装
3. アラーム追加機能の実装
4. アラーム一覧表示機能の実装

### フェーズ2：位置情報連動機能の実装
1. 位置情報取得機能の実装
2. 距離計算機能の実装
3. アラーム停止機能の実装（位置確認付き）
4. アラーム編集機能の実装（位置確認付き）
5. アラーム削除機能の実装（位置確認付き）

### フェーズ3：通知・サウンド機能の実装
1. ローカル通知の実装
2. アラームサウンドの実装
3. 通知画面の実装

### フェーズ4：UI/UXの改善
1. デザインの調整
2. エラーハンドリングの改善
3. ユーザビリティの向上

### フェーズ5：テスト・リリース準備
1. 各種テスト（単体テスト、統合テスト、実機テスト）
2. バグ修正

---

## 8. 用語集

- **Swift：** Appleが開発したiOSアプリケーション開発用のプログラミング言語
- **Core Location：** iOSで位置情報を取得するためのフレームワーク
- **MapKit：** iOSで地図を表示するためのフレームワーク
- **SwiftUI：** Appleが提供する、宣言的なUI構築フレームワーク
- **ローカル通知：** アプリがバックグラウンドでも通知を送信できる機能
- **GPS：** Global Positioning System（全地球測位システム）の略。衛星を使って位置を特定する技術
- **UserNotifications：** iOSでローカル通知（アプリが閉じていても通知を送信できる機能）を実装するためのフレームワーク
- **ローカル通知：** アプリがバックグラウンドでも通知を送信できる機能。アプリが完全に終了していても動作する
- **バックグラウンドモード：** アプリが画面に表示されていない状態でも、特定の処理を継続できる機能

---

## 9. 補足・注意事項

### 9.1 位置情報のプライバシー
- 位置情報の使用には、ユーザーの明示的な許可が必要です

### 9.2 GPSの精度について
- GPSの精度は環境によって異なります（屋内では精度が低下する場合があります）
- 有効範囲の半径設定は、GPSの誤差を考慮して決定する必要があります

### 9.3 バッテリー消費
- 位置情報の取得はバッテリーを消費します
- 適切な更新頻度を設定し、過度なバッテリー消費を避ける必要があります

### 9.4 バックグラウンド動作について
- iOSでは、アプリが完全に終了していてもローカル通知を使用することで、アラームを発火できます
- ローカル通知には、通知の許可が必要です（初回起動時にユーザーに許可を求める）
- 通知の許可が得られない場合、アラーム機能が正常に動作しない可能性があります
- アラームが鳴った際に、通知からアプリを起動できるようにする必要があります
- バックグラウンドでの位置情報取得には、適切な権限設定が必要です

---

## 10. 今後の検討事項

1. マップサービスの選定と実装
2. 有効範囲の半径の決定
3. アラームサウンドの選定
4. バックグラウンド動作の詳細設計
5. 通知機能の詳細設計
6. UI/UXデザインの詳細化

---

**作成日：** 2024年
**バージョン：** 1.0
**最終更新日：** 2024年

